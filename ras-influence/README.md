# Branch / RAS microbenchmark (Zig)

Небольшой бенчмарк для исследования **branch predictor** и **RAS (Return Address Stack)** на x86 под Linux.  
Код написан на **Zig 0.15.2**, perf используется напрямую через `perf_event_open`.

>РАБОТАЕТ ТОЛЬКО НА ПРОЦЕССОРАХ AMD АРХИТЕКТУРЫ ZEN3.

---

## Justfile — кратко по рецептам

### `build`
Собирает бинарь в **ReleaseFast**, отключает frame pointers и сохраняет дизассемблирование.  
Нужно, чтобы код был максимально «чистым» и предсказуемым.

### `bench`
Запускает бенчмарк в контролируемых условиях:

- фиксирует одно ядро (`taskset`)
- realtime-приоритет (`SCHED_FIFO 99`)
- governor → `performance`
- SMT выключается
- результат пишется в CSV

Цель — убрать шум планировщика и частот, измерять именно микроархитектуру.

### `clean`
Удаляет `build/`.

---

## Как работает код

- Есть рекурсивная функция `task(depth)` без tail-call оптимизаций.
- Вызовы идут через **указатели на функции**, заранее разложенные в массив.

Зачем указатели:
- сломать **BTB / TAGE** как источник предсказаний `ret`
- исключить его из игры
- оставить только **RAS / RSB / RAP** как механизмы предсказания возвратов

---

## Что измеряется

Через `perf_event_open` считаются:
- `BRANCH_INSTRUCTIONS`
- `BRANCH_MISSES`
- raw event `0xC9` — **RAS misses** (Zen4)

Бенчмарк многократно выполняет:
```

call_amount × task(call_depth)

```

Результат — CSV с per-try и average значениями:
- общее число ветвлений
- branch misses и miss rate
- RAS misses

---

## Как выглядит

На моем процессоре, размер RAS - 32 адреса.

Как видно, исключая погрешности (от которых не избавиться), рекурсивная функция вложенностью 16 не создает near ret branch misprediction:
```bash
$ just bench 16 10000 100
try_number,total_branches,branch_misses,miss_rate,ras_misses
1,490004,10,0.00,0
2,490004,5,0.00,0
3,490004,4,0.00,0
4,490006,29,0.01,21
5,490004,4,0.00,0
6,490004,4,0.00,0
7,490004,4,0.00,0
8,490004,4,0.00,0
9,490004,4,0.00,0
10,490005,20,0.00,15
11,490004,4,0.00,0
12,490004,4,0.00,0
13,490004,4,0.00,0
14,490004,4,0.00,0
15,490005,20,0.00,15
16,490004,4,0.00,0
17,490004,4,0.00,0
18,490004,4,0.00,0
19,490004,4,0.00,0
20,490004,4,0.00,0
21,490005,12,0.00,6
22,490004,4,0.00,0
23,490004,4,0.00,0
24,490004,4,0.00,0
25,490004,4,0.00,0
26,490004,4,0.00,0
27,490006,30,0.01,24
28,490004,4,0.00,0
29,490004,4,0.00,0
30,490004,4,0.00,0
31,490004,4,0.00,0
32,490005,14,0.00,9
33,490004,4,0.00,0
34,490004,4,0.00,0
35,490004,4,0.00,0
36,490004,4,0.00,0
37,490004,4,0.00,0
38,490006,10,0.00,4
39,490004,4,0.00,0
40,490004,4,0.00,0
41,490004,4,0.00,0
42,490004,4,0.00,0
43,490004,4,0.00,0
44,490005,12,0.00,5
45,490004,4,0.00,0
46,490004,4,0.00,0
47,490004,4,0.00,0
48,490004,4,0.00,0
49,490004,4,0.00,0
50,490006,8,0.00,2
51,490004,4,0.00,0
52,490004,4,0.00,0
53,490004,4,0.00,0
54,490004,4,0.00,0
55,490005,17,0.00,12
56,490004,4,0.00,0
57,490004,4,0.00,0
58,490004,4,0.00,0
59,490004,4,0.00,0
60,490004,4,0.00,0
61,490005,5,0.00,0
62,490004,4,0.00,0
63,490004,4,0.00,0
64,490004,4,0.00,0
65,490004,4,0.00,0
66,490004,4,0.00,0
67,490005,18,0.00,12
68,490004,4,0.00,0
69,490004,4,0.00,0
70,490004,4,0.00,0
71,490004,4,0.00,0
72,490006,22,0.00,16
73,490004,4,0.00,0
74,490004,4,0.00,0
75,490004,4,0.00,0
76,490004,4,0.00,0
77,490004,4,0.00,0
78,490005,11,0.00,5
79,490004,4,0.00,0
80,490004,4,0.00,0
81,490004,4,0.00,0
82,490004,4,0.00,0
83,490004,4,0.00,0
84,490006,23,0.00,16
85,490004,4,0.00,0
86,490004,4,0.00,0
87,490004,4,0.00,0
88,490004,4,0.00,0
89,490005,10,0.00,5
90,490004,4,0.00,0
91,490004,4,0.00,0
92,490004,4,0.00,0
93,490004,4,0.00,0
94,490004,4,0.00,0
95,490006,30,0.01,22
96,490004,4,0.00,0
97,490004,4,0.00,0
98,490004,4,0.00,0
99,490004,4,0.00,0
100,490004,4,0.00,0

average_total_branches,average_branch_misses,average_miss_rate,averate_ras_misses
490004.24,6.30,0.00,1.89
```

Как только мы запускаем бенчмарк для вложенности 32, получаем абсолютно обратную картину:
```bash
try_number,total_branches,branch_misses,miss_rate,ras_misses
1,970004,10019,1.03,9999
2,970005,10038,1.03,10030
3,970004,10004,1.03,10000
4,970005,10037,1.03,10029
5,970004,10004,1.03,10000
6,970004,10004,1.03,10000
7,970006,10030,1.03,10020
8,970004,10004,1.03,10000
9,970004,10004,1.03,10000
10,970006,10027,1.03,10018
11,970004,10004,1.03,10000
12,970005,10021,1.03,10015
13,970004,10004,1.03,10000
14,970004,10004,1.03,10000
15,970005,10018,1.03,10013
16,970004,10004,1.03,10000
17,970005,10012,1.03,10005
18,970004,10004,1.03,10000
19,970004,10004,1.03,10000
20,970006,10060,1.04,10052
21,970004,10004,1.03,10000
22,970004,10004,1.03,10000
23,970005,10012,1.03,10007
24,970004,10004,1.03,10000
25,970005,10036,1.03,10029
26,970004,10004,1.03,10000
27,970004,10004,1.03,10000
28,970005,10006,1.03,10000
29,970004,10004,1.03,10000
30,970004,10004,1.03,10000
31,970005,10029,1.03,10024
32,970004,10004,1.03,10000
33,970006,10031,1.03,10021
34,970004,10004,1.03,10000
35,970004,10004,1.03,10000
36,970005,10005,1.03,10000
37,970004,10004,1.03,10000
38,970005,10008,1.03,10002
39,970004,10004,1.03,10000
40,970004,10004,1.03,10000
41,970005,10017,1.03,10009
42,970004,10004,1.03,10000
43,970004,10004,1.03,10000
44,970005,10030,1.03,10022
45,970004,10004,1.03,10000
46,970005,10029,1.03,10021
47,970004,10004,1.03,10000
48,970004,10004,1.03,10000
49,970005,10019,1.03,10014
50,970004,10004,1.03,10000
51,970004,10004,1.03,10000
52,970006,10036,1.03,10030
53,970004,10004,1.03,10000
54,970005,10033,1.03,10028
55,970004,10004,1.03,10000
56,970004,10004,1.03,10000
57,970006,10049,1.04,10037
58,970004,10004,1.03,10000
59,970005,10005,1.03,10000
60,970004,10004,1.03,10000
61,970004,10004,1.03,10000
62,970005,10033,1.03,10026
63,970004,10004,1.03,10000
64,970004,10004,1.03,10000
65,970005,10035,1.03,10030
66,970004,10004,1.03,10000
67,970006,10047,1.04,10036
68,970004,10004,1.03,10000
69,970004,10004,1.03,10000
70,970006,10029,1.03,10016
71,970004,10004,1.03,10000
72,970004,10004,1.03,10000
73,970005,10025,1.03,10020
74,970004,10004,1.03,10000
75,970005,10020,1.03,10014
76,970004,10004,1.03,10000
77,970004,10004,1.03,10000
78,970005,10025,1.03,10018
79,970004,10004,1.03,10000
80,970004,10004,1.03,10000
81,970005,10035,1.03,10028
82,970004,10004,1.03,10000
83,970006,10027,1.03,10017
84,970004,10004,1.03,10000
85,970004,10004,1.03,10000
86,970005,10006,1.03,10000
87,970004,10004,1.03,10000
88,970005,10020,1.03,10015
89,970004,10004,1.03,10000
90,970004,10004,1.03,10000
91,970005,10019,1.03,10014
92,970004,10004,1.03,10000
93,970004,10004,1.03,10000
94,970006,10018,1.03,10010
95,970004,10004,1.03,10000
96,970006,10035,1.03,10029
97,970004,10004,1.03,10000
98,970004,10004,1.03,10000
99,970005,10030,1.03,10025
100,970004,10004,1.03,10000

average_total_branches,average_branch_misses,average_miss_rate,averate_ras_misses
970004.49,10012.55,1.03,10007.23
```

Огромное количество ошибочных угадываний, вызывающих гигантское негативное влияние на утилизацию возможностей конвейеризации CPU.

---

## Зачем это всё

- увидеть реальные пределы RAS
- понять, как глубина рекурсии влияет на `ret`-предсказание

Не продакшен.
Зато честно и по делу.
